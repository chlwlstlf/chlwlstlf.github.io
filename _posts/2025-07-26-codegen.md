---
layout: single
title: "[Next.js] GraphQL Codegen으로 보안 스키마 가져오기"
categories: next
toc: true
toc_sticky: true
---

# GraphQL, Apollo, Codegen

## <mark class="pink">GraphQL과 Apollo Client란?</mark>

### <mark class="yellow">GraphQL이란?</mark>

**GraphQL**은 API를 위한 쿼리 언어이자 런타임입니다. REST API와 달리 클라이언트가 필요한 데이터만 정확히 요청할 수 있어 over-fetching과 under-fetching 문제를 해결합니다.

```graphql
# 예시: 사용자 정보 요청
query GetUser {
  user(id: "123") {
    name
    email
    posts {
      title
    }
  }
}
```

<br>

### <mark class="yellow">Apollo Client란?</mark>

**Apollo Client**는 GraphQL을 사용하는 React 애플리케이션에서 가장 많이 사용되는 상태 관리 라이브러리입니다. GraphQL 쿼리를 실행하고, 캐싱하며, UI를 업데이트하는 역할을 합니다.

<br>

### <mark class="yellow">GraphQL Code Generator (Codegen)이란?</mark>

**GraphQL Code Generator**는 GraphQL 스키마와 쿼리 파일(.gql)을 분석해서 TypeScript 타입과 React Hooks를 자동으로 생성해주는 도구입니다.

<br>

**동작 흐름**

```
GraphQL Schema + Query Files (.gql)
        ↓
  Code Generator
        ↓
TypeScript Types + React Hooks
```

<br>

**생성되는 것들**

- TypeScript 타입 정의
- Apollo Client용 Custom Hooks (useQuery, useMutation)
- 타입 안전성을 보장하는 코드

<br>
<br>

## <mark class="pink">기존 방식의 문제점</mark>

### <mark class="yellow">기존 구조</mark>

기존에는 GraphQL API 엔드포인트에서 **직접 스키마를 가져오는 방식**을 사용했습니다.

```typescript
// codegen.ts (기존)
import type { CodegenConfig } from "@graphql-codegen/cli";

const config: CodegenConfig = {
  schema: "https://api.example.com/graphql", // GraphQL엔드포인트에서 직접 Introspection
  documents: "src/**/*.gql",
  generates: {
    // TypeScript 타입, React Hooks, 로컬 스키마 생성
  },
};
```

이 방식은 **GraphQL Introspection**을 통해 API에서 직접 스키마 정보를 가져옵니다.

<br>

### <mark class="yellow">GraphQL Introspection의 보안 문제</mark>

**GraphQL Introspection**은 GraphQL API에 특수 쿼리(`__schema`)를 보내 전체 스키마 구조를 가져오는 기능입니다. 개발 단계에서는 편리하지만, 프로덕션 환경에서는 다음과 같은 보안 문제가 있습니다.

1. **API 구조 노출**: 공격자가 전체 스키마 구조를 파악할 수 있음
2. **숨겨진 엔드포인트 발견**: 개발 중이거나 내부용 쿼리/뮤테이션이 노출될 수 있음
3. **공격 표면 증가**: API의 모든 기능을 알게 되어 취약점 공격이 쉬워짐

<br>
<br>

## <mark class="pink">개선한 방식: GitHub 기반 스키마 관리</mark>

### <mark class="yellow">새로운 구조</mark>

보안을 강화하기 위해 **백엔드 API의 GitHub Private Repository에서 스키마 파일을 직접 가져오는 방식**으로 변경했습니다. GitHub Personal Access Token(PAT)을 환경 변수에 설정하여 비공개 레포에 접근합니다.

```bash
# .env
YOUR_GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx
```

<br>

### <mark class="yellow">codegen.ts 상세 분석</mark>

```typescript
const config: CodegenConfig = {
  schema: {
    // 백엔드 API 레포지토리의 스키마 파일 URL
    // 형식: https://raw.githubusercontent.com/{org}/{repo}/{branch}/path/to/schema.gql
    [GITHUB_SCHEMA_URL]: {
      method: "GET",
      handleAsSDL: true, // SDL(Schema Definition Language) 형식으로 처리
      headers: {
        Authorization: `token ${process.env.YOUR_GITHUB_TOKEN}`, // PAT 인증
      },
    },
  },
  // documents, generates은 동일
};

export default config;
```

<br>

### <mark class="yellow">작동 흐름</mark>

```
1. npm run gqlgen 실행
        ↓
2. codegen.ts 실행
        ↓
3. 환경 변수 확인 (NEXT_PUBLIC_ENV)
        ↓
4. GitHub에서 스키마 다운로드
   - 환경별로 적절한 브랜치 선택
   - PAT(Personal Access Token)로 인증
        ↓
5. .gql 파일들 분석
        ↓
6. 코드 생성
   - index.ts: React Apollo Hooks (useQuery, useMutation 등)
   - types.ts: TypeScript 타입 정의
   - schema.graphql: Apollo VSCode Extension용 로컬 스키마
```
