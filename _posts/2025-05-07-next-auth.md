---
layout: single
title: "[Next.js] NextAuth v5, middleware"
categories: next
toc: true
toc_sticky: true
---

# NextAuthë¡œ Access Token ê´€ë¦¬í•˜ê¸°

<br>

**ê´€ë ¨ PR**  
[middleware, logout ê¸°ëŠ¥ ì¶”ê°€](https://github.com/ConSeat/frontend/pull/133)  
[/api ê²½ë¡œ ëª» ì°¾ëŠ” ì˜¤ë¥˜ í•´ê²°](https://github.com/ConSeat/frontend/pull/136)

<br>

## <mark class="pink">ğŸ”¥1. NextAuth ë„ì… ì´ìœ </mark>

**<mark class="yellow">1. SSRì—ì„œëŠ” LocalStorageì— ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤</mark>**

Nextì—ì„œëŠ” SSRì™€ CSR í™˜ê²½ ëª¨ë‘ì—ì„œ í† í°ì„ ê°€ì ¸ì™€ apië¥¼ ìš”ì²­í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. ì´ì „ í”„ë¡œì íŠ¸ì²˜ëŸ¼ Access Tokenì„ localStorageì— ì €ì¥í•˜ê³  ë³´ë‹ˆ ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë–´ë‹¤.

```
ReferenceError: localStorage is not defined
```

SSRì—ì„œëŠ” LocalStorageì— ì ‘ê·¼í•  ìˆ˜ ì—†ê³  window, document ê°™ì€ BOM ë˜í•œ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

<br>

**<mark class="yellow">2. í† í°ì„ ì¿ í‚¤ì— ì €ì¥í•˜ì</mark>**

ê·¸ë˜ì„œ ë‚˜ì˜¨ í•´ê²°ì±…ì´ í† í°ì„ ì¿ í‚¤ì— ì €ì¥í•˜ëŠ” ë°©ë²•ì´ë‹¤.

í˜ì´ì§€ë¥¼ SSRë¡œ ìƒì„±í•  ë•Œ ë¸Œë¼ìš°ì €ëŠ” ì„œë²„ì— HTTP ìš”ì²­ì„ ë³´ë‚´ëŠ”ë° ì´ë•Œ ì¿ í‚¤ ê°’ì´ ìë™ìœ¼ë¡œ í¬í•¨ëœë‹¤. ì´ë•Œ SSRì—ì„œ ì¿ í‚¤ì— ìˆëŠ” ê°’ì„ ì½ì„ ìˆ˜ ìˆë‹¤.

<br>

**<mark class="yellow">3. í† í°ì„ ì¿ í‚¤ì— ì•ˆì „í•˜ê²Œ ì €ì¥í•˜ì</mark>**

`HttpOnly`ë¡œ í† í°ì„ ì¿ í‚¤ì— ì €ì¥í•˜ë©´ clientì—ì„œëŠ” ì¿ í‚¤ì— ìˆëŠ” ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ë‹¤. í•˜ì§€ë§Œ `HttpOnly` ì˜µì…˜ì„ ì œê±°í•˜ë©´ ë³´ì•ˆì´ ì•½í•´ì§„ë‹¤. ë”°ë¼ì„œ `NextAuth.js`ë¥¼ ì‚¬ìš©í•´ì„œ ë³´ì•ˆ ì˜µì…˜ì€ ë‹¤ ì ìš©í•˜ê³  clientì™€ serverì—ì„œ ëª¨ë‘ ì¿ í‚¤ ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ í–ˆë‹¤.

![Image](https://github.com/user-attachments/assets/b1674bc9-45d1-4507-8c4b-b0d471e96629)

ì´ë¥¼ `NextAuth.js`ëŠ” `HttpOnly` ì¿ í‚¤ì— ì €ì¥ëœ ì„¸ì…˜/í† í°ì— í´ë¼ì´ì–¸íŠ¸ì—ì„œë„ "ê°„ì ‘ì ìœ¼ë¡œ" ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í”„ë¡ íŠ¸ ì„œë²„(Next.js API)ë¥¼ ì¤‘ê³„ ì§€ì ìœ¼ë¡œ í™œìš©í•´ í•´ê²°í–ˆë‹¤.

í´ë¼ì´ì–¸íŠ¸ì—ì„œ `/api/auth/session`ì— fetch ìš”ì²­ì„ í•˜ë©´ í”„ë¡ íŠ¸ ì„œë²„ëŠ” ìš”ì²­ì— í¬í•¨ëœ `HttpOnly` ì¿ í‚¤ë¥¼ ë³´ê³  ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•œë‹¤. ìœ íš¨í•˜ë©´ sessionì„ ë°˜í™˜í•˜ì—¬ clientì—ì„œë„ ì½ì„ ìˆ˜ ìˆë‹¤.

![Image](https://github.com/user-attachments/assets/4e428d90-0b80-40eb-b999-e41a5c3a1de2)

<br>
<br>

## <mark class="pink">ğŸ”¥2. NextAuth v5 ì„¤ì¹˜</mark>

ì°¸ê³ : [Upgrade Guide (NextAuth.js v5)](https://authjs.dev/getting-started/migrating-to-v5)

NextAuth beta ë²„ì „ì´ 5ì´ë‹¤. ë²„ì „ 5ëŠ” ì•±ë¼ìš°í„°ì— ìµœì ì´ê¸° ë•Œë¬¸ì— Next.js 14ë²„ì „ ì´ìƒë¶€í„° ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```bash
npm install next-auth@beta
```

<br>
<br>

## <mark class="pink">ğŸ”¥3. AUTH_SECRET ìƒì„±</mark>

`AUTH_SECRET`ëŠ” JWT ì„œëª… ë° ê²€ì¦, ì•”í˜¸í™”ëœ ì„¸ì…˜ ì¿ í‚¤ ìƒì„±, ì´ë©”ì¼ ì¸ì¦ í† í° í•´ì‹œ ë“±ì„ ìœ„í•œ ê°€ì¥ ì¤‘ìš”í•œ í™˜ê²½ ë³€ìˆ˜ì´ë‹¤.

bashì— ì•„ë˜ì™€ ê°™ì´ ì…ë ¥í•˜ë©´ 32ë°”ì´íŠ¸ ì‹œí¬ë¦¿ í‚¤ê°€ ë‚˜ì˜¨ë‹¤. ê·¸ê±¸ envì— ë„£ì–´ì£¼ë©´ ëœë‹¤.

```bash
openssl rand -base64 32
```

**.env**

```
AUTH_SECRET=ì‹œí¬ë¦¿í‚¤
```

<br>
<br>

## <mark class="pink">ğŸ”¥4. auth.ts íŒŒì¼ ìƒì„±</mark>

**<mark class="yellow">auth.ts íŒŒì¼</mark>**

`/src/auth.ts` íŒŒì¼ì„ ìƒì„±í•˜ê³  ì•„ë˜ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.

```ts
import NextAuth from "next-auth";

export const { auth, handlers, signIn, signOut } = NextAuth({
  session: {},
  providers: [],
  callbacks: {},
  session: {},

  secret: process.env.AUTH_SECRET, // ë¹„ë°€í‚¤ ì‘ì„±
});
```

<br>

**<mark class="yellow">1. ì¸ì¦ í•¨ìˆ˜ export</mark>**

ì²« ì¤„ ë¶€í„° ì°¬ì°¬íˆ ì•Œì•„ë³´ì.

**NextAuth v5(App Router ì „ìš©)**ì˜ ì„¤ì • ë°©ì‹ìœ¼ë¡œ, í•µì‹¬ ì¸ì¦ í•¨ìˆ˜ë“¤ì„ NextAuth()ë¡œ ì´ˆê¸°í™”í•œ í›„, auth, handlers, signIn, signOut ë“±ì„ ì„œë²„/í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê°ê° ì ì ˆíˆ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ exportí•˜ëŠ” êµ¬ì¡°ì´ë‹¤.

```ts
export const { auth, handlers, signIn, signOut } = NextAuth({});
```

<br>

**1\. `auth`**

> `HttpOnly` ì¿ í‚¤ë¥¼ íŒŒì‹±í•´ì„œ ìœ ì € ì •ë³´ë¥¼ ë°˜í™˜

- `app/api/*` API í•¸ë“¤ëŸ¬, `middleware.ts`, ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
- ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš© ì˜ˆì‹œ

  ```ts
  import { auth } from "@/auth";

  const session = await auth();
  ```

<br>

**2\. `handlers`**

> ì¸ì¦ ê´€ë ¨ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ í•¸ë“¤ëŸ¬

- `app/api/auth/[...nextauth]/route.ts`ì—ì„œ ì‚¬ìš©
- `/api/auth/session` ìš”ì²­ ì‘ë‹µ
- `/api/auth/signin`, `/signout`, `/callback` ë“± ëª¨ë“  ì¸ì¦ ìš”ì²­ ì²˜ë¦¬

NextAuth v5ì—ì„œëŠ” ì¸ì¦ ê´€ë ¨ ìš”ì²­(`/api/auth/session`, `/api/auth/signin`, `/api/auth/callback` ë“±)ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ **í•¸ë“¤ëŸ¬(route íŒŒì¼)** ë¥¼ ì§ì ‘ ë“±ë¡í•´ì•¼ í•œë‹¤.

**app/api/auth/[...nextauth]/route.ts ë“±ë¡**

```ts
import { handlers } from "@/auth";

export const { GET, POST } = handlers;
```

ë‚´ë¶€ì ìœ¼ë¡œ NextAuthëŠ” ì´ routeë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ìŒ ìš”ì²­ì„ ì²˜ë¦¬í•œë‹¤.

```
GET /api/auth/session
POST /api/auth/signin
GET /api/auth/callback/github ë“±
```

<br>

**3\. `signIn`**

> í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¡œê·¸ì¸ ì‹œë„

- ë¡œê·¸ì¸ ì„±ê³µ -> ì¿ í‚¤ì— HttpOnly ì„¸ì…˜ ì €ì¥

```ts
import { signIn } from "next-auth/react";

await signIn("credentials", {
  accessToken: data.accessToken,
  callbackUrl: "/",
});
```

<br>

**4\. `signOut`**

> í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¡œê·¸ì•„ì›ƒ ìˆ˜í–‰

- ì¿ í‚¤ ì‚­ì œ

```ts
import { signOut } from "next-auth/react";

await signOut({ callbackUrl: "/login" });
```

<br>

**<mark class="yellow">2. session</mark>**

> NextAuthì˜ ì„¸ì…˜ ê´€ë¦¬ ë°©ì‹ì„ ì„¤ì •í•˜ëŠ” ì½”ë“œ

- `strategy : 'jwt' | 'database'`  
  jwt: ì„¸ì…˜ ë°ì´í„°ë¥¼ JWT í† í°ì— ì¸ì½”ë”©í•´ì„œ ì¿ í‚¤ë¡œ ì €ì¥ (stateless)  
  database: ì„¸ì…˜ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥, ì¿ í‚¤ì—” ì„¸ì…˜ IDë§Œ ì €ì¥ (stateful)
- `maxAge`: ì„¸ì…˜ ìœ íš¨ ì‹œê°„ (ì´ˆ ë‹¨ìœ„)

```ts
session: {
  strategy: 'jwt',
  maxAge: 60 * 60 * 24, // 1ì¼
}
```

<br>

**<mark class="yellow">3. providers</mark>**

> ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë¡œê·¸ì¸í•  ê²ƒì¸ì§€ ì •ì˜í•˜ëŠ” ê³³

```ts
providers: [
  Credentials({...}),
  GoogleProvider({...}),
  GitHubProvider({...}),
  ...
]
```

<br>

**`Credentials` providerë€?**

- `name` : ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë³´ì—¬ì§ˆ provider ì´ë¦„
- `credentials` : ë¡œê·¸ì¸ í¼ í•„ë“œ ì •ì˜
- `authorize()` : ìœ ì € ì¸ì¦ ë¡œì§ ìˆ˜í–‰, `signIn()`í•  ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜, `user` ì •ë³´ë¥¼ ë°˜í™˜

```ts
providers: [
  Credentials({
    name: 'Credentials',
    credentials: {
      accessToken: { label: 'Access Token', type: 'text' },
    },
    authorize: async (credentials) => {
      if (!credentials.accessToken || typeof credentials.accessToken !== 'string') {
        throw new Error('Invalid access token');
      }

      // user ì •ë³´ ë°˜í™˜
      return {
        id: credentials.accessToken, // ìœ ì €ë¥¼ ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ëŠ” í‚¤(í•„ìˆ˜)
        accessToken: credentials.accessToken,
      } as User;
    },
  }),
],
```

<br>

**<mark class="yellow">4. callbacks</mark>**

NextAuthì˜ callbacksëŠ” ì¸ì¦ ê³¼ì • ì¤‘ê°„ì— ê°œì…í•  ìˆ˜ ìˆëŠ” í›…(Hook) í•¨ìˆ˜ë“¤ì˜ ì§‘í•©ì´ë‹¤.  
ì´ë¥¼ í†µí•´ JWT í† í°ì´ë‚˜ ì„¸ì…˜ ê°ì²´ì˜ êµ¬ì¡°ë¥¼ ì§ì ‘ ê°€ê³µí•  ìˆ˜ ìˆë‹¤.  
accessTokenì„ JWT ë‚´ë¶€ì— ì €ì¥í•˜ê±°ë‚˜, í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ì‘ë‹µì— íŠ¹ì • ê°’ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

- ë¡œê·¸ì¸ í›„ ë°›ì€ ìœ ì € ì •ë³´(`user`)ë¥¼ JWT payload(`token`)ì— ì¶”ê°€
- JWTì—ì„œ êº¼ë‚¸ ì •ë³´ë¥¼ ì„¸ì…˜ ì‘ë‹µ(`session`)ìœ¼ë¡œ êµ¬ì„±í•˜ëŠ” ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰

<br>

**1\. `jwt` ì½œë°±**

> âœ… ì´ ì½œë°±ì€ JWTë¥¼ ì–´ë–»ê²Œ êµ¬ì„±í• ì§€ ì •ì˜í•˜ëŠ” ë‹¨ê³„

- JWT ì„¸ì…˜ ì „ëµ(`session.strategy: 'jwt'`)ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ë¡œê·¸ì¸ ì„±ê³µ ì‹œ `authorize()`ì—ì„œ ë°˜í™˜í•œ `user` ê°ì²´ê°€ `jwt()`ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
- ì´ ì½œë°±ì—ì„œ ë°˜í™˜í•œ `token` ê°ì²´ëŠ” JWTì˜ payloadë¡œ ì‚¬ìš©ë˜ë©°, NextAuthê°€ ì´ë¥¼ **ì„œëª…(sign)í•˜ì—¬ ì¿ í‚¤ì— ì €ì¥**
- ì´í›„ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´, NextAuthëŠ” ì¿ í‚¤ì—ì„œ JWTë¥¼ ì½ì–´ **ë³µí˜¸í™”**í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë‹¤ì‹œ `token`ìœ¼ë¡œ ì œê³µí•˜ì—¬ `jwt()`ë¥¼ ìš”ì²­ë§ˆë‹¤ í˜¸ì¶œ
- JWTì˜ `exp`ë¥¼ ì´ìš©í•´ accessToken ë§Œë£Œ ì—¬ë¶€ë¥¼ ê²€ì‚¬í•˜ê±°ë‚˜, í•„ìš”í•œ ê²½ìš° í† í° ì¬ë°œê¸‰ ë¡œì§ì„ ë„£ì„ ìˆ˜ ìˆìŒ

- `user` : ë¡œê·¸ì¸ ì§í›„ í•œ ë²ˆë§Œ ì¡´ì¬(`authorize()`ì—ì„œ ë¦¬í„´í•œ user ê°ì²´)
- `token` : NextAuthê°€ ë‚´ë¶€ì ìœ¼ë¡œ ìƒì„±Â·ìœ ì§€í•˜ëŠ” JWTì˜ payload ê°ì²´

<br>

**2\. `session` ì½œë°±**

> âœ… ì´ ì½œë°±ì€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì–´ë–¤ ì„¸ì…˜ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤„ì§€ ì •ì˜í•˜ëŠ” ë‹¨ê³„

- í´ë¼ì´ì–¸íŠ¸ê°€ `useSession()` í›…ì„ ì‚¬ìš©í•˜ê±°ë‚˜ `/api/auth/session` ìš”ì²­ì„ ë³´ë‚¼ ë•Œ ì‹¤í–‰
- ì´ë•Œ NextAuthëŠ” ì¿ í‚¤ì—ì„œ JWTë¥¼ ì½ê³  ë³µí˜¸í™”í•˜ì—¬ `token`ìœ¼ë¡œ ì „ë‹¬
- ìš°ë¦¬ëŠ” ì—¬ê¸°ì„œ JWT ë‚´ë¶€ ì •ë³´(`token.accessToken` ë“±)ë¥¼ í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ì‘ë‹µ(`session`)ì— ì¶”ê°€ ê°€ëŠ¥
- ìµœì¢…ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ëŠ” `useSession()`ì„ í†µí•´ ê°€ê³µëœ ì„¸ì…˜ ë°ì´í„°ë¥¼ ë°›ì•„ ì‚¬ìš©

- `session` : í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜ë  ì„¸ì…˜ ê°ì²´
- `token` : ë³µí˜¸í™”ëœ JWTì˜ payload(`callbacks.jwt()`ì—ì„œ ë¦¬í„´í•œ ë‚´ìš©)

```ts
callbacks: {
  jwt: ({ token, user }) => {
    if (user) { // ì²˜ìŒ ë¡œê·¸ì¸ í•  ë•Œ tokenì— authorizeì—ì„œ ë°˜í™˜í•œ user ì •ë³´ ì €ì¥
      token.accessToken = user.accessToken;
      const { exp } = jwtDecode<{ exp: number }>(user.accessToken);
      token.accessTokenExpires = exp * 1000;
    }

    if (Date.now() < (token.accessTokenExpires ?? 0)) {
      return token;
    }

    return {};
  },

  session: ({ session, token }) => {
    session.accessToken = token.accessToken as string; // ì»¤ìŠ¤í…€ í•„ë“œ ì¶”ê°€
    return session;
  },
},
```

<br>

**nextAuth.d.ts - ì»¤ìŠ¤í…€ í•„ë“œ ì¶”ê°€**

```ts
import "next-auth";
import "next-auth/jwt";

declare module "next-auth" {
  interface Session {
    accessToken?: string;
  }
  interface User {
    accessToken: string;
  }
}

declare module "next-auth/jwt" {
  interface JWT {
    accessToken?: string;
    accessTokenExpires?: number;
  }
}
```

<br>

**<mark class="yellow">ì „ì²´ íë¦„</mark>**

```
1. ë¡œê·¸ì¸ ì„±ê³µ
  â†³ authorize() â†’ user ë¦¬í„´
  â†³ jwt({ token, user }) â†’ JWT payload êµ¬ì„±
  â†³ JWT ì„œëª… í›„ ì¿ í‚¤ì— ì €ì¥

2. ì´í›„ ìš”ì²­ ë³´ë‚´ë©´
  â†³ JWT ì¿ í‚¤ ìë™ í¬í•¨ â†’ ì„œë²„ì—ì„œ ë³µí˜¸í™”
  â†³ jwt({ token }) â†’ ë§Œë£Œ ì—¬ë¶€ ë“± ê²€ì¦
  â†³ session({ session, token }) â†’ ì„¸ì…˜ ì‘ë‹µ êµ¬ì„±
  â†³ í´ë¼ì´ì–¸íŠ¸ëŠ” useSession()ìœ¼ë¡œ ì„¸ì…˜ ë°ì´í„° í™•ì¸
```

<br>
<br>

## <mark class="pink">ğŸ”¥5. Universal auth()</mark>

NextAuth v5ì—ì„œëŠ” `auth()`ë¼ëŠ” ë‹¨ì¼ APIë¥¼ í†µí•´ ì„œë²„ ì¸¡ì—ì„œë„ ì¸ì¦ ìƒíƒœë¥¼ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ í•¨ìˆ˜ëŠ” JWT ì¿ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ì½ê³  ë³µí˜¸í™”í•œ ë’¤, ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜í•œë‹¤.

**1\. sever**

v5ì—ì„œëŠ” `@/auth`ì—ì„œ import í•œë‹¤.

```ts
import { auth } from "@/auth";

const session = await auth();
console.log(session?.accessToken);
```

<br>

**2\. client**

`getSession` í•¨ìˆ˜ê°€ ì‚¬ë¼ì§€ê³  v5ì—ì„œëŠ” `useSession`ë§Œ ê¶Œì¥ëœë‹¤.  
í•˜ì§€ë§Œ utilí•¨ìˆ˜ì—ì„œëŠ” `useSession`ì„ ëª» ì“°ë¯€ë¡œ ì§ì ‘ apië¥¼ ìš”ì²­í•˜ì—¬ sessionì„ ë°›ì•„ì˜¨ë‹¤.

```ts
const res = await fetch("/api/auth/session");
const session = await res.json();
console.log(session?.accessToken);
```

<br>

**3\. client component**

[status] ë¬¸ìì—´ ë¦¬í„°ëŸ´

- `loading`: ì„¸ì…˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì¼ ë•Œ
- `unauthenticated`: ì„¸ì…˜ì´ ì—†ì–´ì„œ ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ ë•Œ
- `authenticated`: ì„¸ì…˜ì´ ì¡´ì¬í•´ì„œ ë¡œê·¸ì¸ëœ ìƒíƒœì¼ ë•Œ

```tsx
"use client";

import { useSession } from "next-auth/react";

const { data: session, status } = useSession();
const isLogin = status === "authenticated" && !!session?.user;
```

<br>

**4\. middleware**

```ts
import { auth } from "@/auth";

export default auth((req) => {
  // ë¯¸ë“¤ì›¨ì–´ ì½”ë“œ
});
```

<br>
<br>

## <mark class="pink">ğŸ”¥6. SessionStorage ì¶”ê°€</mark>

NextAuth v5ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì„¸ì…˜ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´, `useSession()` í›…ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.  
í•˜ì§€ë§Œ ì´ í›…ì´ ë™ì‘í•˜ë ¤ë©´ ë°˜ë“œì‹œ ìƒìœ„ì— `SessionProvider`ë¡œ contextê°€ ê°ì‹¸ì ¸ ìˆì–´ì•¼ í•œë‹¤.

<br>

**<mark class="yellow">ê³µì‹ ë¬¸ì„œ: SessionProviderì— session prop ì£¼ì…</mark>**

ì°¸ê³ : [Upgrade Guide (v4) \| NextAuth.js](https://next-auth.js.org/getting-started/upgrade-v4#sessionprovider)

ê³µì‹ ë¬¸ì„œì—ì„œ "ì´ˆê¸° ì„¸ì…˜ì„ ì£¼ì…í•˜ë©´ ì²« í™”ë©´ì—ì„œ ê¹œë¹¡ì„(ë¡œë”©) ì—†ì´ UIë¥¼ ê·¸ë¦´ ìˆ˜ ìˆë‹¤ ë¼ê³  ë˜ì–´ ìˆì–´ì„œ sessionì„ ìƒìœ„ì—ì„œ í˜¸ì¶œí•´ provider ì¸ìì— ë„£ì–´ì£¼ì—ˆë‹¤.

```tsx
// `session` comes from `getServerSideProps` or `getInitialProps`.
// Avoids flickering/session loading on first load.
<SessionProvider session={session} refetchInterval={5 * 60}>
  <Component {...pageProps} />
</SessionProvider>
```

<br>

**<mark class="yellow">ì‹¤ì œ ì½”ë“œ</mark>**

**providers/AuthProvider.tsx**

```tsx
export const AuthProvider = ({ children, session }: AuthProviderProps) => {
  return (
    <SessionProvider
      session={session} // session ì£¼ì…
      refetchOnWindowFocus={false}
    >
      {children}
    </SessionProvider>
  );
};
```

<br>

**app/layout.tsx**

```tsx
const RootLayout = async ({ children }) => {
  const session = await auth(); // sessionì„ AuthProviderì— ì „ë‹¬

  return (
    <html lang="ko" className={`${pretendard.variable}`}>
      <body className={pretendard.className}>
        <AuthProvider session={session}>{children}</AuthProvider>
      </body>
    </html>
  );
};
```

<br>
<br>

## <mark class="pink">ğŸ”¥6. middleware ìƒì„±</mark>

ì¸ì¦ì´ í•„ìš”í•œ í˜ì´ì§€/ê²½ë¡œì— ì ‘ê·¼ ì œí•œí•˜ê³  ì‹¶ì„ ë•Œ `middleware`ì—ì„œ ì¸ì¦ì„ ì²´í¬í•˜ê³  ë¼ìš°íŒ…í•  ìˆ˜ ìˆë‹¤.

- `auth()` ë‚´ë¶€ì—ì„œ JWT ì¿ í‚¤ë¥¼ ìë™ ë³µí˜¸í™”í•˜ì—¬ ì¸ì¦ ì •ë³´ í™•ì¸
- `req.auth`ê°€ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœ -> "/signin" í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
- `matcher` : middleware ì‹¤í–‰ ëŒ€ìƒ ê²½ë¡œ, ë³´í˜¸ ëŒ€ìƒ í˜ì´ì§€

```ts
import { NextResponse } from "next/server";
import { auth } from "@/auth";

const SIGNIN_PATH = "/signin";

export default auth((req) => {
  if (!req.auth) {
    return NextResponse.redirect(new URL(SIGNIN_PATH, req.url));
  }
  return NextResponse.next();
});

export const config = {
  matcher: [
    "/mypage/:path*",
    "/home/:stadiumId/review/:path*",
    "/settings/:path*",
  ],
};
```

<br>
<br>

## <mark class="pink">ğŸ¤”basePath ë³€ê²½í•˜ê¸°</mark>

**<mark class="yellow">[ë¬¸ì œì ]</mark>**

ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë–´ë‹¤.

```
GET https://concertseat.site/api/auth/session 400 (Bad Request)
```

```
body: null
header: {message: "No static resource api/auth/session."}
```

<br>

**<mark class="yellow">[ì›ì¸]</mark>**

ë¡œì»¬ì—ì„œ ì˜ ë˜ê³ , ì˜ˆì „ì— ë‚˜ì˜ ë‹¤ë¥¸ ë²„ì…€ ë„ë©”ì¸ìœ¼ë¡œ ë°°í¬í–ˆì„ ë•Œë„ ì˜ ëëŠ”ë° `https://concertseat.site/` ì—¬ê¸°ì„œë§Œ ì•ˆ ëë‹¤.

ì´ê²ƒìœ¼ë¡œ ì§ì‘í–ˆì„ ë•Œ ë°±ì—”ë“œ api ìš”ì²­ë„ `https://concertseat.site/api`ë¡œ ë³´ë‚´ê³  ìˆëŠ”ë° ì´ê±¸ Nextê°€ í”„ë¡ íŠ¸ ì„œë²„ì™€ êµ¬ë¶„ì„ ëª» í•˜ê³  ìˆëŠ” ê²ƒ ê°™ì•˜ë‹¤.

<br>

**<mark class="yellow">[í•´ê²° ë°©ë²•]</mark>**

ë°±ì—”ë“œ ì„œë²„ urlì„ ë°”ê¾¸ëŠ” ê±´ ë¹„ìš©ì´ ë§¤ìš° í¬ë‹ˆ í”„ë¡ íŠ¸ ì„œë²„ urlì„ `/api`ê°€ ì•„ë‹Œ ë‹¤ë¥¸ ê²ƒìœ¼ë¡œ ë³€ê²½í–ˆë‹¤.

ì°¸ê³ : [https://authjs.dev/reference/nextjs#basepath](https://authjs.dev/reference/nextjs#basepath)

ì›ë˜ëŠ” basePathê°€ `app/api/auth/[...nextauth]/route.ts`ë¼ì„œ ì„¤ì •ì„ ìƒëµí•˜ì§€ë§Œ `app/auth/[...nextauth]/route.ts`ë¡œ ë³€ê²½í•  ì˜ˆì •ì´ê¸° ë•Œë¬¸ì— 3ê°œ ì„¤ì •ì„ ì¶”ê°€í•´ì¤€ë‹¤.

**1\. `src/auth.ts`ì— `basePath: '/auth'` ì¶”ê°€**

```ts
export const { auth, handlers, signIn, signOut } = NextAuth({
  session: {},
  providers: [],
  callbacks: {},

  secret: process.env.AUTH_SECRET,
  basePath: "/auth", // ì¶”ê°€
} as NextAuthConfig);
```

<br>

**2\. SessionProvider ì†ì„±ì— `basePath="/auth"` ì¶”ê°€**

```tsx
<SessionProvider
  session={session}
  basePath="/auth" // ì¶”ê°€
  refetchOnWindowFocus={false}
>
  {children}
</SessionProvider>
```

<br>

**3\. AUTH_URL ë’¤ì— `/auth` ì¶”ê°€**

ìœ„ì—ì„œ AUTH_SECRETë¥¼ ìƒì„±í•  ë•Œ AUTH_URLì€ envì— ì¶”ê°€í•˜ì§€ ì•Šì•˜ë‹¤. ì—†ìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ `https://your-domain.com/api/auth`ì— api ìš”ì²­ì„ í•˜ê¸° ë•Œë¬¸ì´ë‹¤. í•˜ì§€ë§Œ ì§€ê¸ˆì€ basePathê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ë³€ê²½í•œ í›„ì— envì— ì¶”ê°€í•´ì¤€ë‹¤.

```
AUTH_URL=https://concertseat.site/auth
```

<br>
<br>

## <mark class="pink">ğŸ”¥ë§ˆë¬´ë¦¬</mark>

ì´ë²ˆ ê¸€ì—ì„œëŠ” NextAuthì˜ ì´ˆê¸° ì„¤ì • ê³¼ì •ê³¼, ì„œë²„Â·í´ë¼ì´ì–¸íŠ¸ ì „ë°˜ì—ì„œ ì„¸ì…˜ì„ ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ê¹Œì§€ ì •ë¦¬í•´ë³´ì•˜ë‹¤.  
`auth()`, `callbacks`, `SessionProvider`, `middleware` ë“± NextAuth v5ì—ì„œì˜ ì¸ì¦ íë¦„ì— ëŒ€í•´ ê³µë¶€í•œ í›„ í”„ë¡œì íŠ¸ì— ì ìš©í•˜ì˜€ë‹¤.

ë‹¤ìŒ ê¸€ì—ì„œëŠ” ì´ ì¸ì¦ êµ¬ì¡°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, **ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ì–‘ìª½ì—ì„œ ì¸ì¦ëœ API ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” universal API êµ¬ì„±**, ê·¸ë¦¬ê³  **Tanstack Queryì™€ í•˜ì´ë“œë ˆì´ì…˜ê¹Œì§€ ì—°ë™í•˜ëŠ” ì‹¤ì „ ì˜ˆì œ**ë¥¼ ë‹¤ë£° ì˜ˆì •ì´ë‹¤.
